<<<<<<< HEAD
### 1. 開催概要
| 項目 | 内容 |
| :--- | :---------- |
| **セッション名** | AWSにおけるグレー障害の検出と対策 |
| **日時** | 2025年6月26日 14:50～ |
| **発表者** | 安藤 麻衣 氏 (アマゾン ウェブ サービス ジャパン合同会社 ストラテジックインダストリー技術本部 通信第三ソリューション部 ソリューションアーキテクト) |
| **概要** | 本セッションは、システムの完全停止には至らないものの、ユーザー体験を低下させる「グレー障害」の特性、検出、対策について解説するものである。Amazon CloudWatchのContributor Insightsや複合アラームを用いた具体的な検出手法、そしてAmazon Application Recovery Controller (ARC) を活用したアベイラビリティゾーン（AZ）の退避といった対応策について掘り下げ、障害対応訓練の重要性にも言及した。 |

### 2. 主要なポイント

#### グレー障害の定義とその影響
グレー障害とは、システムが完全に停止しているわけではないが、一部のコンポーネントの不調により、サービス品質が断続的または部分的に低下している状態を指す。例えば、「一部のユーザーのみECサイトのカート投入に失敗する」「全体の平均レイテンシは正常値だが、特定ユーザー群のレスポンスが著しく遅延する」といった事象が該当する。
このような障害は、システム全体のメトリクス（CPU使用率、ネットワークトラフィック等）上は正常に見えることが多く、従来の監視手法では検知が極めて困難である。しかし、ユーザー体験を著しく損ない、ビジネスに影響を及ぼす可能性があるため、対策が不可欠である。

#### グレー障害の検出手法
従来のシステム監視や、単純なヘルスチェック（シャローヘルスチェック）では検知が難しいグレー障害に対し、本セッションではAmazon CloudWatchを活用した高度な検出手法が紹介された。

* **ディメンションの活用とContributor Insights:**
    CloudWatchメトリクスに、InstanceIDだけでなく、AZ-IDやCustomerIDといったビジネスコンテキストを持つ「ディメンション」を追加することが推奨された。これにより、高カーディナリティ（種類が非常に多い）データの中から、どのインスタンス、どのAZ、どのユーザーが障害の影響を受けているかを特定する「Contributor Insights」機能が有効に活用できる。ログに所定のフォーマット（EMF: Embedded Metric Format）でメトリクスを埋め込むことで、これを実現できる。

* **複合アラーム (Composite Alarms):**
    複数のアラームの状態を「AND/OR/NOT」で組み合わせ、より複雑で的確な障害検知ロジックを構築する手法である。例えば、「AZ-1でレイテンシ悪化アラームが発報 **かつ** AZ-2では発報していない」という条件を設定することで、単一AZに閉じた問題であることを高い精度で特定し、誤報を減らしながら迅速な切り分けを支援する。

#### グレー障害への対応戦略
障害の検出後、影響を最小限に抑えるための対応策として、以下の3つのレベルが提示された。

1.  **インスタンス単位での対応:**
    障害を起こしているインスタンスを特定し、再起動や新しいインスタンスへの置き換えを行う。比較的シンプルな対応だが、効果は当該リソースに限定される。

2.  **アプリケーションレベルでの対応（グレイスフルデグラデーション）:**
    障害発生時に、システムのコアではない機能（例：レコメンデーション機能）を意図的に停止（デグレード）させ、主要機能（例：商品検索、決済）の提供を継続する設計思想である。これにより、システム全体を停止させることなく、ユーザーへの影響を最小限に抑えることが可能となる。Amazonの検索ページでも緊急時には表示情報を減らしてサービスを継続する実例が紹介された。

3.  **ロケーション単位での対応（AZの切り離し / ゾーンシフト）:**
    特定のAZで広範な品質低下が確認された場合に、そのAZへのトラフィックを停止し、正常なAZのみでサービスを継続する最も強力な対応策である。これを実現するためには、以下の設計が重要となる。
    * **Availability Zone Independence (AZI):** AZ間で不要な依存関係をなくし、AZ内で処理が完結するアーキテクチャを目指す。具体的には、ELBのクロスゾーン負荷分散を無効化し、各AZに配置したDBリードレプリカを同一AZ内のインスタンスから参照するなどの工夫が必要である。
    * **Amazon Application Recovery Controller (ARC):** 問題のあるAZからのトラフィック退避（ゾーンシフト）を、数分という短時間で実行するマネージドサービス。明確なSLO/SLIを定義し、それをトリガーに手動または自動（ゾーンオートシフト）で実行することで、迅速な影響回避が可能となる。ゾーンシフトに備え、1つのAZが停止しても残りのAZで負荷を処理できるよう、リソースを予め多めにプロビジョニングしておく必要がある。

#### 障害対応訓練とレジリエンス文化の醸成
グレー障害への備えとして、障害対応訓練の重要性が強調された。

* **AWS Fault Injection Service (FIS):**
    本番環境に近い環境で、意図的に障害を発生させる「障害注入実験」を行うためのサービスである。SSMドキュメントと連携し、レイテンシの追加やパケットロスの発生といった、グレー障害を忠実に再現したシナリオを実行できる。また、ARCと連携してゾーンシフトの訓練を行うことも可能である。

* **文化の醸成:**
    障害訓練を特別なイベントと捉えるのではなく、日常的な活動として組織に定着させることが重要である。訓練を通じて得られた課題をプロセスの改善に繋げ、PDCAサイクルを回していくことで、組織全体のレジリエンス（回復力）を高めることができると結論付けられた。
=======
# AWS におけるグレー障害の検出と対策

## 日時
2025/6/26 14:50

## 発表者
安藤 麻衣

アマゾン ウェブ サービス ジャパン合同会社
ストラテジックインダストリー技術本部通信第三ソリューション部 ソリューションアーキテクト

## abstract
グレー障害は、クラウド環境でアプリケーションのパフォーマンスに微妙な影響を与えることが多い、検出が困難な障害です。これらの障害は、システムの全体的なダウンタイムにはつながらないかもしれませんが、ユーザーエクスペリエンスの低下や潜在的なデータ損失につながる可能性があります。このセッションでは、グレー障害の特性と AWS 環境での一般的な発生シナリオを紹介します。さらに、グレー障害を効果的に検出するための技術と戦略を紹介し、Amazon CloudWatch の Contributor Insights、および複合アラームの使用方法について掘り下げます。また、グレー障害に対処するためのアプローチ、特に Application Recovery Controller を使用した Availability Zone の退避について解説します。

## 概要メモ
- グレー障害：一部のユーザーのみ発生して、テストユーザーでは正常のこと
  - アプリが使えなくなった和kではないが、評価が低下する
- 平均レイテンシーはアラームを下回っているが、一部のユーザーのレイテンシーが莫大に増えている状態
- 視点別のObservability
  - システムは見ている側によって状態が異なる
  - 根本的に解決されるまで様々な状態に変化する
- ケースのアーキテクチャ
- ユーザーからクレームが入った
  - ALBのヘルスチェックでは問題が起きていない
- 特定のインスタンスに影響が出ていることがある
  - 期待通りのレスポンスができていない
  - エラー率が100%でない
- AZレベルでの品質低下
- ALBヘルスチェックで検知できない問題
  - シャロー：インスタンスとデータベースの依存はチェックしない
  - ディープ：依存関係もチェックする
    - 粒度が荒くなりがち
    - 依存関係に問題があっても、全員スタンスで影響があると誤解してしまう
- グレー障害は検知の困難さ
- COntrbuter Insights
  - 高カーディナり：一位の値になってしまう
- 複合アラーム
  - AZ1で複数の問題が発生しているかを検出することができる
- グレー障害への対応
  - グレイスフルでグラデーション
    - 機能制限してもユーザー体験は大きく損なわれるわけではない：という考え方
    - アプリケーションがわで事前に準備することで対応することが可能
  - AZの切り離し
    - グレー障害の原因特定は時間がかかることがある
    - ALB
      - デフォルトではAZに均等に分散させる：クロスゾーン負荷分散
    - データベース
      - マッピング情報をDynamoDBに保存
    - ARC（アーク）
      - 一時的な退避としてしようすることができる
  - AZ障害が起きた時、これを切り離す判断はどうする？
    - SLO、SLI
    - ゾーンオートシフト
      - 自動的に検知して対応可能
      - 手動対応を減らすことができる
      - メール通知もできる
      - 選択肢の一つとして
- 障害訓練
  - AWS Fault Injection Service FIS
    - シナリオライブラリ
      - あらかじめ実験テンプレートが用紙されている
        - AZの電力がダウンした場合のシナリオがある
      - SSMドキュメント：実際のグレー障害のように微妙な障害を起こすことができる
  - PDCAを繰り返すことで組織全体の対応力を務めることができる
  - 
>>>>>>> c4022de53fd400287e7b5dcadd1ad68adbe05274
