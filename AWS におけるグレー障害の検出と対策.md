# AWS におけるグレー障害の検出と対策

## 日時
2025/6/26 14:50

## 発表者
安藤 麻衣

アマゾン ウェブ サービス ジャパン合同会社
ストラテジックインダストリー技術本部通信第三ソリューション部 ソリューションアーキテクト

## abstract
グレー障害は、クラウド環境でアプリケーションのパフォーマンスに微妙な影響を与えることが多い、検出が困難な障害です。これらの障害は、システムの全体的なダウンタイムにはつながらないかもしれませんが、ユーザーエクスペリエンスの低下や潜在的なデータ損失につながる可能性があります。このセッションでは、グレー障害の特性と AWS 環境での一般的な発生シナリオを紹介します。さらに、グレー障害を効果的に検出するための技術と戦略を紹介し、Amazon CloudWatch の Contributor Insights、および複合アラームの使用方法について掘り下げます。また、グレー障害に対処するためのアプローチ、特に Application Recovery Controller を使用した Availability Zone の退避について解説します。

## 概要メモ
- グレー障害：一部のユーザーのみ発生して、テストユーザーでは正常のこと
  - アプリが使えなくなった和kではないが、評価が低下する
- 平均レイテンシーはアラームを下回っているが、一部のユーザーのレイテンシーが莫大に増えている状態
- 視点別のObservability
  - システムは見ている側によって状態が異なる
  - 根本的に解決されるまで様々な状態に変化する
- ケースのアーキテクチャ
- ユーザーからクレームが入った
  - ALBのヘルスチェックでは問題が起きていない
- 特定のインスタンスに影響が出ていることがある
  - 期待通りのレスポンスができていない
  - エラー率が100%でない
- AZレベルでの品質低下
- ALBヘルスチェックで検知できない問題
  - シャロー：インスタンスとデータベースの依存はチェックしない
  - ディープ：依存関係もチェックする
    - 粒度が荒くなりがち
    - 依存関係に問題があっても、全員スタンスで影響があると誤解してしまう
- グレー障害は検知の困難さ
- COntrbuter Insights
  - 高カーディナり：一位の値になってしまう
- 複合アラーム
  - AZ1で複数の問題が発生しているかを検出することができる
- グレー障害への対応
  - グレイスフルでグラデーション
    - 機能制限してもユーザー体験は大きく損なわれるわけではない：という考え方
    - アプリケーションがわで事前に準備することで対応することが可能
  - AZの切り離し
    - グレー障害の原因特定は時間がかかることがある
    - ALB
      - デフォルトではAZに均等に分散させる：クロスゾーン負荷分散
    - データベース
      - マッピング情報をDynamoDBに保存
    - ARC（アーク）
      - 一時的な退避としてしようすることができる
  - AZ障害が起きた時、これを切り離す判断はどうする？
    - SLO、SLI
    - ゾーンオートシフト
      - 自動的に検知して対応可能
      - 手動対応を減らすことができる
      - メール通知もできる
      - 選択肢の一つとして
- 障害訓練
  - AWS Fault Injection Service FIS
    - シナリオライブラリ
      - あらかじめ実験テンプレートが用紙されている
        - AZの電力がダウンした場合のシナリオがある
      - SSMドキュメント：実際のグレー障害のように微妙な障害を起こすことができる
  - PDCAを繰り返すことで組織全体の対応力を務めることができる
  - 