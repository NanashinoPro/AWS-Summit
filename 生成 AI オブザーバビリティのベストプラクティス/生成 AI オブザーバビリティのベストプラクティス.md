<<<<<<< HEAD
### 1. 開催概要

| 項目 | 内容 |
| :--- | :---------- |
| **セッション名** | 生成 AI オブザーバビリティのベストプラクティス (AWS-49) |
| **日時** | 2025年6月26日 13:50 |
| **発表者** | 津和崎 美希 氏 (アマゾン ウェブ サービス ジャパン合同会社 ストラテジックインダストリー技術本部 通信第一ソリューション部 ソリューションアーキテクト) |
| **概要** | 本セッションは、生成AIアプリケーションを概念実証（PoC）から本番環境へ移行する際に直面する「品質」「パフォーマンス」「コスト」の課題に対し、「オブザーバビリティ」の観点から解決策を提示するものであった。オブザーバビリティの3本柱であるメトリクス、ログ、トレースを計測するための階層的アプローチを紹介。特に、Amazon CloudWatchを用いた基本的なコンポーネント監視から、RAGアーキテクチャやエージェントのトレース、Amazon Bedrock Guardrailsによる高度な分析、エンドユーザーからのフィードバック収集まで、具体的な実装方法がデモを交えて解説された。 |

### 2. 主要なポイント

#### 2.1. 生成AIの本番導入における課題とオブザーバビリティの重要性
2023年に多くの企業が生成AIのPoCを終えたが、2024年の本番導入に向けては「暗雲」が立ち込めている。その主要な課題は「品質」「パフォーマンス」「コスト」の3点である。

* **品質**: 最大の課題は、不正確な情報を生成する「ハルシネーション」であり、ユーザーの信頼を著しく損なうリスクがある。
* **パフォーマンスとコスト**: 応答速度と利用コストはトレードオフの関係にあり、ユーザー体験を左右する重要な要素である。1980年代のソフトウェアですら高速応答性が求められていた歴史も紹介された。
* **RAGアーキテクチャ**: これらの課題、特に品質問題を解決するアプローチとしてRAG（Retrieval-Augmented Generation）が有効である。しかし、自前で構築すると、データの取り込み、分割、ベクトル化、DB格納など、パイプラインの運用が複雑になるという問題点も指摘された。

これらの複雑なシステムの状態を外部から理解するために、オブザーバビリティが不可欠である。オブザーバビリティは「メトリクス」「ログ」「トレース」の3つの柱で構成される。

#### 2.2. オブザーバビリティを計測するための階層型アプローチ
本セッションでは、基本的な監視からより深い分析へと進む4つの階層型アプローチが提唱された。

**レイヤー1: コンポーネントレベルのメトリクスとログ**
アプリケーションとインフラストラクチャの基本的な監視を行う層である。
* **メトリクス**: AWSの各サービスは、特別な設定なしで利用可能なメトリクス（Vended Metrics）を自動でCloudWatchに発行する。ディメンションを指定することで、モデルIDごとに入出力トークン数を把握するなど、詳細な分析が可能となる。また、複数のアラームを組み合わせ、特定の条件が揃った時のみ通知する「複合アラーム」により、アラームノイズを削減できる。
* **ログ**: Amazon Bedrockでは、モデルの呼び出しログ（入出力データなど）を収集する設定を有効化できる。収集したログはCloudWatch Logs Insightsの`pattern`コマンドで分析でき、MLアルゴリズムによって自動でパターンが発見されるため、ユーザーの利用傾向などを効率的に把握可能である。

**レイヤー2: RAG・エージェント・チェーントレース**
複数のコンポーネントが連携するRAGアーキテクチャ全体の処理の流れを追跡する層である。
* **トレースの仕組み**: リクエスト全体に単一の「Trace ID」を付与し、各処理（API Gateway, Lambdaなど）を「Span」として記録することで、リクエストの経路と各処理時間を可視化する。
* **実装**: OpenTelemetry (OTel) SDKを利用してアプリケーションを計装する。デモでは、OTelを用いて親子関係を持つSpanを作成し、処理のボトルネック（例：BedrockとRAGの呼び出し）を特定する様子が示された。また、LLMアプリケーションのトレースに特化したOpenLLMetryやOpenLITといったライブラリも紹介された。

**レイヤー3: 高度な指標と分析（Guardrails）**
アプリケーションの品質と安全性を担保するための高度な分析を行う層である。
* **Amazon Bedrock Guardrails**: 責任あるAIポリシーに基づき、有害コンテンツのフィルタリング、拒否されたトピックの定義・禁止、レスポンス内の機密情報（PII）のマスキングなどが可能である。デモでは、「税金を回避する方法」といった不適切な質問に対してガードレールが作動する様子が示された。
* **監視**: ガードレールの動作状況（介入した呼び出し数、レイテンシー等）はCloudWatchメトリクスとして収集され、ポリシーごとのパフォーマンス監視が可能である。

**レイヤー4: エンドユーザーからのフィードバック**
最終的なユーザー体験を計測し、オブザーバビリティのループを完成させる層である。
* **フィードバック収集**: 👍👎ボタンや自由記述など、ユーザーからのフィードバックを収集する。
* **CloudWatch EMF**: CloudWatch Embedded Metrics Format (EMF) を利用することで、フィードバック（例：Sentiment=1）のような定性的なデータを、構造化されたログおよびメトリクスとしてCloudWatchに送信できる。これにより、ユーザー満足度の低下をトリガーとしたアラームを設定するなど、より直接的にユーザー体験を監視することが可能になる。

#### 2.3. まとめ
本セッションで提示されたベストプラクティスは以下の4点に要約される。
1.  まず、AWSサービスが標準で提供するエラー、レイテンシー、呼び出しログといったメトリクスとログの監視から始めること。
2.  次に、トレースを使用してコンポーネント間の連携を可視化し、RAGやエージェントベースのアーキテクチャを深く理解すること。
3.  ガードレールの介入状況やモデルのドリフト検出など、高度なメトリクスを導入し、品質と安全性を担保すること。
4.  最後に、エンドユーザーからのフィードバックを品質評価や障害アラートに組み込み、継続的な改善ループを完成させること。
=======
# 生成 AI オブザーバビリティのベストプラクティス

## 日時
2025/6/26 13:50

## 発表者
津和崎 美希

アマゾン ウェブ サービス ジャパン合同会社
ストラテジックインダストリー技術本部通信第一ソリューション部ソリューションアーキテクト

## abstract
生成 AI の採用が進む中、信頼性、透明性、最適化を確保するための包括的な可観測性が重要になっています。このセッションでは、大規模言語モデル、Retrieval Augmented Generation（RAG）アーキテクチャ、その他の新しいアプローチを含む、さまざまな生成 AI パターンの可観測性の課題について学びます。Amazon CloudWatch を幅広いメトリクス、ログ、分散トレーシングと共に使用して、生成 AI ワークロードのライフサイクルの可視性を獲得する方法を発見します。さらに、生成 AI アプリケーションを構築するための強力なフレームワークである LangChain の役割と、Amazon Bedrock や Amazon SageMaker と組み合わせて開発およびデプロイメントパイプライン全体の可観測性を向上させる方法についても探ります。

## 概要メモ
- オブザーバビリティが専門の人はちらほら……
- BYTEマガジン：AIに特化した特別号から抜粋
  - RAGやエージェントを匂わせる内容が
- ハルシネーションを起こさない
  - 評価やベンチマークからモデルを選定
  - 場合によってはチューニング
- レイテンシー
  - 80年代：15秒がゴールドスタンダードだった
  - 生成AI：数秒単位になってしまった……
- 生成AIの出力の精度を高めるためのアーキテクチャ例：RAG
  - 取り込みメカニズム
  - 分割
  - ベクトル化
  - ベクトルDB
  - クエリして使う
- Guardrails：侮辱する言葉などを防ぐことができる
- レイヤー
- オブザーバビリティ
  - サービスの状態を理解すること
  - トレース
    - 生成AI：ワークフローで入出力、トークンなどの出力情報
    - オブザ：分散トレーシング、RAG全体での処理の分散度について
- CloudWatch：最近の進化がものすごい
- レイヤー1
  - コンポーネントレベルのメトリクスが無料で使える：Vended Metrics
  - ディメンション
    - モデル別のトークン数を取得するときに使う
  - 複合アラーム
    - 複数のアラームが異常な時だけアラームを出す
  - モデル呼び出しログ
    - Bedrockでは有効化の設定が必要：設定方法は簡単
  - ログパターンの分析
- chatbotアプリ
  - Python
  - Streamlit
- 特別な設定をせずともCloudWatchに自動的に送られる
- ログ
  - 入出力を見ることができる
  - パターンで分析することもできる
    - ユーザーの使用状況を可視化することができる
- トレース
  - Trace IDで追跡することができる
- OTel
  - 親SPanと子Spanを作成
- デモ
  - S3：PDFが格納
  - ナレッジベースの範囲外の内容は応答できない
  - 3秒以上かかったトレーズをクエリできる
    - BedrockとRAGの呼び出しに時間がかかっていた
  - OpenTelemetry：OpenLLMetry、OpenLIT：LLM用のトレース機能
  - でも画像
- Guardrailsのメトリクス
  - いろんなメトリクスがある
  - ディメンションで区分け可能
  - デモ
    - 不正行為に焦点を当てる
    - 税金を回避する方法を教えてと聞いてみる
      - ガードレール発動！
    - ガードレールのIDをコードに組み込んでアプリに組み込むこともできる
    - CloudWatchでも見ることができる
      - ガードレールのarn別にレイテンシが表示される
- エンドユーザーからのフィードバック
  - Telemetryデータ：ユーザーの感情ちが入っている
    - ログに入力可能
  - ログを構造化して目と陸とログを創刊させることができる
  - EMF：いろんな実装方法がある
- まとめ
  - AWSが提供するログ・メトリクスをフル活用しよう
  - トレースを活用してコンポーネント化んのやり取りを理解しよう
  - ガードレールの利用状況を理解しよう
  - エンドユーザからのフィードバックを取得しよう
  - 
>>>>>>> c4022de53fd400287e7b5dcadd1ad68adbe05274
