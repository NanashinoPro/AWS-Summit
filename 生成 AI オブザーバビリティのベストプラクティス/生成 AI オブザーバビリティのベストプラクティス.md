### 1. 開催概要

| 項目 | 内容 |
| :--- | :---------- |
| **セッション名** | 生成 AI オブザーバビリティのベストプラクティス (AWS-49) |
| **日時** | 2025年6月26日 13:50 |
| **発表者** | 津和崎 美希 氏 (アマゾン ウェブ サービス ジャパン合同会社 ストラテジックインダストリー技術本部 通信第一ソリューション部 ソリューションアーキテクト) |
| **概要** | 本セッションは、生成AIアプリケーションを概念実証（PoC）から本番環境へ移行する際に直面する「品質」「パフォーマンス」「コスト」の課題に対し、「オブザーバビリティ」の観点から解決策を提示するものであった。オブザーバビリティの3本柱であるメトリクス、ログ、トレースを計測するための階層的アプローチを紹介。特に、Amazon CloudWatchを用いた基本的なコンポーネント監視から、RAGアーキテクチャやエージェントのトレース、Amazon Bedrock Guardrailsによる高度な分析、エンドユーザーからのフィードバック収集まで、具体的な実装方法がデモを交えて解説された。 |

### 2. 主要なポイント

#### 2.1. 生成AIの本番導入における課題とオブザーバビリティの重要性
2023年に多くの企業が生成AIのPoCを終えたが、2024年の本番導入に向けては「暗雲」が立ち込めている。その主要な課題は「品質」「パフォーマンス」「コスト」の3点である。

* **品質**: 最大の課題は、不正確な情報を生成する「ハルシネーション」であり、ユーザーの信頼を著しく損なうリスクがある。
* **パフォーマンスとコスト**: 応答速度と利用コストはトレードオフの関係にあり、ユーザー体験を左右する重要な要素である。1980年代のソフトウェアですら高速応答性が求められていた歴史も紹介された。
* **RAGアーキテクチャ**: これらの課題、特に品質問題を解決するアプローチとしてRAG（Retrieval-Augmented Generation）が有効である。しかし、自前で構築すると、データの取り込み、分割、ベクトル化、DB格納など、パイプラインの運用が複雑になるという問題点も指摘された。

これらの複雑なシステムの状態を外部から理解するために、オブザーバビリティが不可欠である。オブザーバビリティは「メトリクス」「ログ」「トレース」の3つの柱で構成される。

#### 2.2. オブザーバビリティを計測するための階層型アプローチ
本セッションでは、基本的な監視からより深い分析へと進む4つの階層型アプローチが提唱された。

**レイヤー1: コンポーネントレベルのメトリクスとログ**
アプリケーションとインフラストラクチャの基本的な監視を行う層である。
* **メトリクス**: AWSの各サービスは、特別な設定なしで利用可能なメトリクス（Vended Metrics）を自動でCloudWatchに発行する。ディメンションを指定することで、モデルIDごとに入出力トークン数を把握するなど、詳細な分析が可能となる。また、複数のアラームを組み合わせ、特定の条件が揃った時のみ通知する「複合アラーム」により、アラームノイズを削減できる。
* **ログ**: Amazon Bedrockでは、モデルの呼び出しログ（入出力データなど）を収集する設定を有効化できる。収集したログはCloudWatch Logs Insightsの`pattern`コマンドで分析でき、MLアルゴリズムによって自動でパターンが発見されるため、ユーザーの利用傾向などを効率的に把握可能である。

**レイヤー2: RAG・エージェント・チェーントレース**
複数のコンポーネントが連携するRAGアーキテクチャ全体の処理の流れを追跡する層である。
* **トレースの仕組み**: リクエスト全体に単一の「Trace ID」を付与し、各処理（API Gateway, Lambdaなど）を「Span」として記録することで、リクエストの経路と各処理時間を可視化する。
* **実装**: OpenTelemetry (OTel) SDKを利用してアプリケーションを計装する。デモでは、OTelを用いて親子関係を持つSpanを作成し、処理のボトルネック（例：BedrockとRAGの呼び出し）を特定する様子が示された。また、LLMアプリケーションのトレースに特化したOpenLLMetryやOpenLITといったライブラリも紹介された。

**レイヤー3: 高度な指標と分析（Guardrails）**
アプリケーションの品質と安全性を担保するための高度な分析を行う層である。
* **Amazon Bedrock Guardrails**: 責任あるAIポリシーに基づき、有害コンテンツのフィルタリング、拒否されたトピックの定義・禁止、レスポンス内の機密情報（PII）のマスキングなどが可能である。デモでは、「税金を回避する方法」といった不適切な質問に対してガードレールが作動する様子が示された。
* **監視**: ガードレールの動作状況（介入した呼び出し数、レイテンシー等）はCloudWatchメトリクスとして収集され、ポリシーごとのパフォーマンス監視が可能である。

**レイヤー4: エンドユーザーからのフィードバック**
最終的なユーザー体験を計測し、オブザーバビリティのループを完成させる層である。
* **フィードバック収集**: 👍👎ボタンや自由記述など、ユーザーからのフィードバックを収集する。
* **CloudWatch EMF**: CloudWatch Embedded Metrics Format (EMF) を利用することで、フィードバック（例：Sentiment=1）のような定性的なデータを、構造化されたログおよびメトリクスとしてCloudWatchに送信できる。これにより、ユーザー満足度の低下をトリガーとしたアラームを設定するなど、より直接的にユーザー体験を監視することが可能になる。

#### 2.3. まとめ
本セッションで提示されたベストプラクティスは以下の4点に要約される。
1.  まず、AWSサービスが標準で提供するエラー、レイテンシー、呼び出しログといったメトリクスとログの監視から始めること。
2.  次に、トレースを使用してコンポーネント間の連携を可視化し、RAGやエージェントベースのアーキテクチャを深く理解すること。
3.  ガードレールの介入状況やモデルのドリフト検出など、高度なメトリクスを導入し、品質と安全性を担保すること。
4.  最後に、エンドユーザーからのフィードバックを品質評価や障害アラートに組み込み、継続的な改善ループを完成させること。
